<?php

// tests/Feature/UserCrudTest.php

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

beforeEach(function () {
    // Create an admin user for authenticated requests
    $this->adminUser = User::factory()->create([
        'email' => 'admin@test.com'
    ]);
    
    // Create a regular user for testing
    $this->regularUser = User::factory()->create([
        'email' => 'user@test.com',
        'name' => 'John Doe',
    ]);
});

describe('User CRUD Operations', function () {
    
    describe('Index (List Users)', function () {
        
        it('can list all users for authenticated admin', function () {
            // Create additional users
            User::factory(5)->create();
            
            $response = $this->actingAs($this->adminUser)
                ->getJson('/api/users');
            
            $response->assertStatus(200)
                ->assertJsonStructure([
                    'data' => [
                        '*' => [
                            'id',
                            'name',
                            'email',
                            'created_at',
                            'updated_at'
                        ]
                    ],
                    'links',
                    'meta'
                ]);
            
            expect($response->json('meta.total'))->toBeGreaterThanOrEqual(7);
        });
        
        it('returns paginated results', function () {
            User::factory(25)->create();
            
            $response = $this->actingAs($this->adminUser)
                ->getJson('/api/users?per_page=10');
            
            $response->assertStatus(200);
            
            expect($response->json('meta.per_page'))->toBe(10);
            expect($response->json('data'))->toHaveCount(10);
            expect($response->json('meta.total'))->toBe(27); // 25 + 2 from beforeEach
        });
        
        it('can filter users by search term', function () {
            User::factory()->create(['name' => 'Jane Smith', 'email' => 'jane@test.com']);
            User::factory()->create(['name' => 'Bob Johnson', 'email' => 'bob@test.com']);
            
            $response = $this->actingAs($this->adminUser)
                ->getJson('/api/users?search=Jane');
            
            $response->assertStatus(200);
            
            expect($response->json('data'))->toHaveCount(1);
            expect($response->json('data.0.name'))->toBe('Jane Smith');
        });
        
        it('denies access to non-admin users', function () {
            $response = $this->actingAs($this->regularUser)
                ->getJson('/api/users');
            
            $response->assertStatus(403);
        });
        
        it('requires authentication', function () {
            $response = $this->getJson('/api/users');
            
            $response->assertStatus(401);
        });
    });
    
    describe('Show (Get Single User)', function () {
        
        it('can show a specific user', function () {
            $response = $this->actingAs($this->adminUser)
                ->getJson("/api/users/{$this->regularUser->id}");
            
            $response->assertStatus(200)
                ->assertJson([
                    'data' => [
                        'id' => $this->regularUser->id,
                        'name' => $this->regularUser->name,
                        'email' => $this->regularUser->email,
                    ]
                ]);
        });
        
        it('returns 404 for non-existent user', function () {
            $response = $this->actingAs($this->adminUser)
                ->getJson('/api/users/999999');
            
            $response->assertStatus(404);
        });
        
        it('allows users to view their own profile', function () {
            $response = $this->actingAs($this->regularUser)
                ->getJson("/api/users/{$this->regularUser->id}");
            
            $response->assertStatus(200);
        });
        
        it('denies access to other users for regular users', function () {
            $otherUser = User::factory()->create();
            
            $response = $this->actingAs($this->regularUser)
                ->getJson("/api/users/{$otherUser->id}");
            
            $response->assertStatus(403);
        });
    });
    
    describe('Store (Create User)', function () {
        
        it('can create a new user with valid data', function () {
            $userData = [
                'name' => 'New User',
                'email' => 'newuser@test.com',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(201)
                ->assertJsonStructure([
                    'data' => [
                        'id',
                        'name',
                        'email',
                        'created_at',
                        'updated_at'
                    ]
                ]);
            
            $this->assertDatabaseHas('users', [
                'name' => 'New User',
                'email' => 'newuser@test.com',
            ]);
            
            expect($response->json('data.name'))->toBe('New User');
        });
        
        it('validates required fields', function () {
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', []);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors([
                    'name',
                    'email',
                    'password'
                ]);
        });
        
        it('validates email uniqueness', function () {
            $userData = [
                'name' => 'Test User',
                'email' => $this->regularUser->email, // Existing email
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors(['email']);
        });
        
        it('validates email format', function () {
            $userData = [
                'name' => 'Test User',
                'email' => 'invalid-email',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors(['email']);
        });
        
        it('validates password confirmation', function () {
            $userData = [
                'name' => 'Test User',
                'email' => 'test@example.com',
                'password' => 'password123',
                'password_confirmation' => 'different_password',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors(['password']);
        });
        
        it('hashes the password', function () {
            $userData = [
                'name' => 'Test User',
                'email' => 'test@example.com',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(201);
            
            $user = User::where('email', 'test@example.com')->first();
            expect(Hash::check('password123', $user->password))->toBeTrue();
        });
        
        it('denies access to regular users', function () {
            $userData = [
                'name' => 'Test User',
                'email' => 'test@example.com',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->regularUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(403);
        });
    });
    
    describe('Update (Edit User)', function () {
        
        it('can update user with valid data', function () {
            $updateData = [
                'name' => 'Updated Name',
                'email' => 'updated@test.com',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->putJson("/api/users/{$this->regularUser->id}", $updateData);
            
            $response->assertStatus(200)
                ->assertJson([
                    'data' => [
                        'id' => $this->regularUser->id,
                        'name' => 'Updated Name',
                        'email' => 'updated@test.com',
                    ]
                ]);
            
            $this->assertDatabaseHas('users', [
                'id' => $this->regularUser->id,
                'name' => 'Updated Name',
                'email' => 'updated@test.com',
            ]);
        });
        
        it('can update password', function () {
            $updateData = [
                'name' => $this->regularUser->name,
                'email' => $this->regularUser->email,
                'password' => 'newpassword123',
                'password_confirmation' => 'newpassword123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->putJson("/api/users/{$this->regularUser->id}", $updateData);
            
            $response->assertStatus(200);
            
            $this->regularUser->refresh();
            expect(Hash::check('newpassword123', $this->regularUser->password))->toBeTrue();
        });
        
        it('can update without changing password', function () {
            $originalPassword = $this->regularUser->password;
            
            $updateData = [
                'name' => 'Updated Name Only',
                'email' => $this->regularUser->email,
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->putJson("/api/users/{$this->regularUser->id}", $updateData);
            
            $response->assertStatus(200);
            
            $this->regularUser->refresh();
            expect($this->regularUser->password)->toBe($originalPassword);
        });
        
        it('validates email uniqueness on update', function () {
            $anotherUser = User::factory()->create();
            
            $updateData = [
                'name' => 'Test',
                'email' => $anotherUser->email,
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->putJson("/api/users/{$this->regularUser->id}", $updateData);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors(['email']);
        });
        
        it('allows users to update their own profile', function () {
            $updateData = [
                'name' => 'Self Updated',
                'email' => 'self@updated.com',
            ];
            
            $response = $this->actingAs($this->regularUser)
                ->putJson("/api/users/{$this->regularUser->id}", $updateData);
            
            $response->assertStatus(200);
        });
        
        it('denies regular users from updating other users', function () {
            $otherUser = User::factory()->create();
            
            $updateData = [
                'name' => 'Unauthorized Update',
                'email' => 'unauthorized@test.com',
            ];
            
            $response = $this->actingAs($this->regularUser)
                ->putJson("/api/users/{$otherUser->id}", $updateData);
            
            $response->assertStatus(403);
        });
        
        it('returns 404 for non-existent user', function () {
            $response = $this->actingAs($this->adminUser)
                ->putJson('/api/users/999999', [
                    'name' => 'Test',
                    'email' => 'test@test.com'
                ]);
            
            $response->assertStatus(404);
        });
    });
    
    describe('Destroy (Delete User)', function () {
        
        it('can delete a user', function () {
            $userToDelete = User::factory()->create();
            
            $response = $this->actingAs($this->adminUser)
                ->deleteJson("/api/users/{$userToDelete->id}");
            
            $response->assertStatus(204);
            
            $this->assertDatabaseMissing('users', [
                'id' => $userToDelete->id,
            ]);
        });
        
        it('returns 404 when deleting non-existent user', function () {
            $response = $this->actingAs($this->adminUser)
                ->deleteJson('/api/users/999999');
            
            $response->assertStatus(404);
        });
        
        it('denies regular users from deleting users', function () {
            $userToDelete = User::factory()->create();
            
            $response = $this->actingAs($this->regularUser)
                ->deleteJson("/api/users/{$userToDelete->id}");
            
            $response->assertStatus(403);
        });
        
        it('prevents users from deleting themselves', function () {
            $response = $this->actingAs($this->adminUser)
                ->deleteJson("/api/users/{$this->adminUser->id}");
            
            $response->assertStatus(422)
                ->assertJson([
                    'message' => 'You cannot delete your own account.'
                ]);
        });
        
        it('soft deletes user when using soft deletes', function () {
            // Assuming User model uses SoftDeletes trait
            $userToDelete = User::factory()->create();
            
            $response = $this->actingAs($this->adminUser)
                ->deleteJson("/api/users/{$userToDelete->id}");
            
            $response->assertStatus(204);
            
            // Check if soft deleted
            $this->assertSoftDeleted('users', [
                'id' => $userToDelete->id,
            ]);
        });
    });
    
    describe('Authorization', function () {
        
        it('requires authentication for all endpoints', function () {
            $user = User::factory()->create();
            
            $this->getJson('/api/users')->assertStatus(401);
            $this->getJson("/api/users/{$user->id}")->assertStatus(401);
            $this->postJson('/api/users', [])->assertStatus(401);
            $this->putJson("/api/users/{$user->id}", [])->assertStatus(401);
            $this->deleteJson("/api/users/{$user->id}")->assertStatus(401);
        });
        
        it('enforces admin role for admin-only endpoints', function () {
            $user = User::factory()->create();
            
            // Test with regular user
            $this->actingAs($this->regularUser)
                ->getJson('/api/users')
                ->assertStatus(403);
                
            $this->actingAs($this->regularUser)
                ->postJson('/api/users', [])
                ->assertStatus(403);
                
            $this->actingAs($this->regularUser)
                ->deleteJson("/api/users/{$user->id}")
                ->assertStatus(403);
        });
    });
    
    describe('Edge Cases', function () {
        
        it('handles malformed JSON gracefully', function () {
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', "{'malformed': json}");
            
            $response->assertStatus(400);
        });
        
        it('handles very long names', function () {
            $longName = str_repeat('A', 300);
            
            $userData = [
                'name' => $longName,
                'email' => 'test@example.com',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            $response = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            
            $response->assertStatus(422)
                ->assertJsonValidationErrors(['name']);
        });
        
        it('handles concurrent user creation with same email', function () {
            $userData = [
                'name' => 'Test User',
                'email' => 'concurrent@test.com',
                'password' => 'password123',
                'password_confirmation' => 'password123',
            ];
            
            // First request should succeed
            $response1 = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            $response1->assertStatus(201);
            
            // Second request with same email should fail
            $response2 = $this->actingAs($this->adminUser)
                ->postJson('/api/users', $userData);
            $response2->assertStatus(422)
                ->assertJsonValidationErrors(['email']);
        });
    });
});

// Helper functions for the tests
function createUserData(array $overrides = []): array
{
    return array_merge([
        'name' => fake()->name(),
        'email' => fake()->unique()->safeEmail(),
        'password' => 'password123',
        'password_confirmation' => 'password123',
    ], $overrides);
}